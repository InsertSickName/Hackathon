<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agricultural Subsidy Leakage Detector + AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Spectre.css for UI -->
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

  <style>
    :root {
      --accent: #2b7a78;
      --accent-dark: #205b5e;
      --bg: #f6f7f9;
      --text: #1f2937;
      --danger: #dc2626;
      --warning: #f59e0b;
    }
    body { background: var(--bg); color: var(--text); }
    .navbar { background: white; border-bottom: 1px solid #e6e8eb; }
    .brand { color: var(--accent); font-weight: 700; letter-spacing: 0.3px; }
    .container { max-width: 1280px; padding: 1rem; }
    .card { border: 1px solid #e6e8eb; }
    .kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi .card { background: white; }
    .kpi-value { font-size: 1.6rem; font-weight: 700; }
    .kpi-label { color: #6b7280; font-size: 0.9rem; }
    .grid-2 { display: grid; grid-template-columns: 1.35fr 1fr; gap: 12px; margin-top: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px; }
    #map { height: 420px; border-radius: 6px; border: 1px solid #e6e8eb; }
    canvas { min-height: 280px; }
    .chip { background: #eef7f6; color: var(--accent-dark); padding: 4px 8px; border-radius: 16px; font-size: 0.85rem; }
    .badge-danger { background: #ffe6e6; color: #b91c1c; }
    .badge-warning { background: #fff5e6; color: #b45309; }
    .badge-success { background: #eafff2; color: #166534; }
    .note { color: #6b7280; font-size: 0.85rem; }
    .sticky { position: sticky; top: 0; background: white; z-index: 5; }
    table { width: 100%; }
    .table tbody tr:hover { background: #f2f6f6; cursor: pointer; }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-dark); border-color: var(--accent-dark); }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .spinner { display:none; }
    .spinner.show { display:inline-block; }
    .heat-legend { display:flex; gap:6px; align-items:center; }
    .legend-dot { width:14px; height:14px; border-radius:50%; display:inline-block; }
    .legend-dot.red { background: var(--danger); }
    .legend-dot.orange { background: var(--warning); }
    .legend-dot.teal { background: var(--accent); }

    /* AI assistant */
    .assistant-card { height: 100%; display: flex; flex-direction: column; }
    .chat-window { background: #fff; border: 1px solid #e6e8eb; border-radius: 6px; height: 560px; display: flex; flex-direction: column; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
    .msg { margin: 8px 0; }
    .msg.user { text-align: right; }
    .msg.user .bubble { background: #e3f2f1; color: #114b5f; display: inline-block; padding: 8px 10px; border-radius: 12px 12px 0 12px; }
    .msg.ai .bubble { background: #f8fafc; border: 1px solid #e6e8eb; display: inline-block; padding: 8px 10px; border-radius: 12px 12px 12px 0; }
    .chat-input { display: flex; gap: 6px; padding: 8px; border-top: 1px solid #e6e8eb; }
    .quick-actions { display: flex; gap: 6px; flex-wrap: wrap; padding: 8px; border-bottom: 1px solid #e6e8eb; }
    .qa-btn { background: #eef7f6; color: #205b5e; padding: 4px 8px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; }
    .typing { font-size: 0.85rem; color: #6b7280; padding-left: 6px; }
  </style>
</head>
<body>
  <header class="navbar">
    <section class="navbar-section container">
      <span class="brand">Agri Subsidy Leakage Detector + AI</span>
    </section>
  </header>

  <main class="container">
    <div class="columns">
      <!-- Left: Dashboard -->
      <div class="column col-8 col-sm-12">
        <div class="card">
          <div class="card-header">
            <div class="card-title h5">Overview</div>
            <div class="card-subtitle text-gray">
              Explore anomalies across dealers, beneficiaries, seasons, and geographies. Click charts, rows, and map markers to drill down.
            </div>
          </div>
          <div class="card-body">
            <!-- KPIs -->
            <div class="kpi" id="kpi">
              <div class="card p-2">
                <div class="kpi-value" id="kpiTransactions">0</div>
                <div class="kpi-label">Transactions</div>
              </div>
              <div class="card p-2">
                <div class="kpi-value" id="kpiBeneficiaries">0</div>
                <div class="kpi-label">Unique beneficiaries</div>
              </div>
              <div class="card p-2">
                <div class="kpi-value" id="kpiDealers">0</div>
                <div class="kpi-label">Dealers</div>
              </div>
              <div class="card p-2">
                <div class="kpi-value" id="kpiAnomalies">0</div>
                <div class="kpi-label">Flagged anomalies</div>
              </div>
            </div>

            <!-- Charts -->
            <div class="grid-2">
              <div class="card p-2">
                <div class="toolbar">
                  <div class="h6">Dealer transaction volumes</div>
                  <span class="chip">Click a bar to drill down</span>
                </div>
                <canvas id="chartDealerVolume"></canvas>
              </div>
              <div class="card p-2">
                <div class="toolbar">
                  <div class="h6">Anomaly types</div>
                  <span class="chip">Hover for counts</span>
                </div>
                <canvas id="chartAnomalyTypes"></canvas>
              </div>
            </div>

            <!-- Map + filters -->
            <div class="grid-2">
              <div class="card p-2">
                <div class="toolbar">
                  <div class="h6">Geospatial clusters</div>
                  <label class="form-switch">
                    <input type="checkbox" id="toggleHeat">
                    <i class="form-icon"></i> Density circles
                  </label>
                  <span class="chip">Click markers for details</span>
                </div>
                <div id="map"></div>
                <div class="note mt-2">
                  <span class="legend-dot red"></span> High anomaly share
                  <span class="legend-dot orange"></span> Medium
                  <span class="legend-dot teal"></span> Low
                </div>
              </div>

              <div class="card p-2">
                <div class="h6">Filters & thresholds</div>
                <div class="form-group">
                  <label class="form-label">Scheme</label>
                  <select id="filterScheme" class="form-select">
                    <option value="">All</option>
                    <option value="Fertilizer">Fertilizer</option>
                    <option value="Seeds">Seeds</option>
                    <option value="Equipment">Equipment</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Season</label>
                  <select id="filterSeason" class="form-select">
                    <option value="">All</option>
                    <option value="Kharif">Kharif</option>
                    <option value="Rabi">Rabi</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">District</label>
                  <input id="filterDistrict" class="form-input" placeholder="e.g., Belagavi" />
                </div>
                <div class="form-group">
                  <label class="form-label">Anomaly severity</label>
                  <select id="filterSeverity" class="form-select">
                    <option value="">All</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>

                <div class="divider"></div>
                <div class="form-group">
                  <label class="form-label">Dealer z-score threshold: <span id="zLabel">2.0</span></label>
                  <input type="range" id="zSlider" min="1" max="5" step="0.1" value="2.0">
                </div>
                <div class="form-group">
                  <label class="form-label">Quantity vs land ratio threshold: <span id="ratioLabel">1.3</span>x</label>
                  <input type="range" id="ratioSlider" min="1.0" max="2.5" step="0.05" value="1.3">
                </div>
                <div class="form-group">
                  <label class="form-label">Date range</label>
                  <div class="input-group">
                    <input type="date" id="dateStart" class="form-input">
                    <span class="input-group-addon">to</span>
                    <input type="date" id="dateEnd" class="form-input">
                  </div>
                </div>

                <div class="toolbar mt-1">
                  <button class="btn btn-primary" id="applyFilters">Apply filters</button>
                  <button class="btn" id="resetFilters">Reset</button>
                  <button class="btn btn-link" id="downloadReport">Download anomalies CSV</button>
                  <span class="chip" id="chipActiveFilters">No filters</span>
                </div>
              </div>
            </div>

            <!-- Anomaly table -->
            <div class="card mt-2">
              <div class="card-header">
                <div class="toolbar">
                  <div class="card-title h6">Flagged anomalies</div>
                  <input class="form-input" id="tableSearch" placeholder="Search table (dealer, beneficiary, district...)" style="max-width:280px">
                </div>
                <div class="card-subtitle text-gray">Click a row to locate on map</div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped" id="anomalyTable">
                    <thead class="sticky">
                      <tr>
                        <th data-sort="severity">Severity</th>
                        <th data-sort="score">Score</th>
                        <th data-sort="type">Type</th>
                        <th data-sort="dealer">Dealer</th>
                        <th data-sort="beneficiary">Beneficiary</th>
                        <th data-sort="scheme">Scheme</th>
                        <th data-sort="season">Season</th>
                        <th data-sort="district">District</th>
                        <th data-sort="quantity">Qty</th>
                        <th data-sort="landHolding">Land (acre)</th>
                        <th data-sort="date">Date</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                  <div class="note"><span id="tableCount"></span></div>
                </div>
              </div>
            </div>

            <!-- Drilldowns & upload -->
            <div class="grid-3">
              <div class="card p-2">
                <div class="h6">Dealer drilldown</div>
                <div class="form-group">
                  <input id="dealerSearch" class="form-input" placeholder="Search dealer by name or ID" />
                </div>
                <div id="dealerInfo" class="note">Enter a dealer name or ID, or click a bar in the chart.</div>
              </div>

              <div class="card p-2">
                <div class="h6">Beneficiary drilldown</div>
                <div class="form-group">
                  <input id="beneficiarySearch" class="form-input" placeholder="Search beneficiary by name or ID" />
                </div>
                <div id="beneficiaryInfo" class="note">Enter a beneficiary ID, or click a row in the anomalies table.</div>
              </div>

              <div class="card p-2">
                <div class="h6">Upload data</div>
                <p class="note">Upload a transactions CSV with columns:
                  transactionId,dealerId,dealerName,beneficiaryId,beneficiaryName,scheme,season,district,quantity,landHolding,lat,lon,date
                </p>
                <div class="toolbar">
                  <input type="file" id="fileInput" accept=".csv" />
                  <span class="spinner" id="loadSpinner">Loading...</span>
                </div>
                <div class="divider"></div>
                <button class="btn" id="loadSample">Load sample dataset</button>
              </div>
            </div>
          </div>
        </div>

        <div class="footer note mt-2">
          Built for transparency and accountability in agricultural subsidy distribution.
        </div>
      </div>

      <!-- Right: AI Assistant -->
      <div class="column col-4 col-sm-12">
        <div class="card assistant-card">
          <div class="card-header">
            <div class="card-title h6">AI assistant</div>
            <div class="card-subtitle text-gray">Ask questions, apply filters, and generate audit checklists.</div>
          </div>
          <div class="card-body">
            <div class="chat-window">
              <div class="quick-actions">
                <span class="qa-btn" data-q="Summarize the current anomalies.">Summarize anomalies</span>
                <span class="qa-btn" data-q="Show top 5 dealers by anomaly count.">Top dealers</span>
                <span class="qa-btn" data-q="Apply filters for Seeds in Kharif with High severity.">Apply Seeds/Kharif/High</span>
                <span class="qa-btn" data-q="Highlight geospatial clusters.">Show clusters</span>
                <span class="qa-btn" data-q="Create an audit checklist for the riskiest district.">Audit checklist</span>
              </div>
              <div id="chatMessages" class="chat-messages"></div>
              <div class="chat-input">
                <input id="chatInput" class="form-input" placeholder="Ask: Which district looks riskiest? Or: Filter Haveri High anomalies." />
                <button id="chatSend" class="btn btn-primary">Ask</button>
                <span id="typingIndicator" class="typing hidden">Thinking…</span>
              </div>
            </div>
            <div class="note mt-2">
              The assistant analyzes the data you loaded. It can:
              - Summarize anomalies and clusters
              - Apply filters from natural language
              - Surface top dealers/beneficiaries by risk
              - Generate audit checklists
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Dependencies -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    let transactions = [];
    let anomalies = [];
    let filteredAnomalies = [];
    let dealerStats = new Map();
    let charts = {};
    let map, markersLayer;

    // thresholds (interactive)
    let dealerZThreshold = 2.0;
    let quantityRatioThreshold = 1.3;

    const schemeCapsPerAcre = { Fertilizer: 1.5, Seeds: 12, Equipment: 0.2 };

    // ---------------------------
    // Sample data generator
    // ---------------------------
    function makeSampleData(rows = 800) {
      const districts = ["Belagavi","Bidar","Ballari","Haveri","Kalaburagi","Mysuru","Mandya","Tumakuru","Dharwad","Koppal"];
      const dealers = Array.from({length: 25}, (_,i)=>({
        dealerId: "D"+String(i+1).padStart(3,"0"),
        dealerName: "Dealer "+(i+1),
        district: districts[Math.floor(Math.random()*districts.length)]
      }));
      const beneficiaries = Array.from({length: 300}, (_,i)=>({
        beneficiaryId: "B"+String(i+1).padStart(4,"0"),
        beneficiaryName: "Farmer "+(i+1),
        landHolding: +(Math.random()*6+0.5).toFixed(2)
      }));
      const schemes = ["Fertilizer","Seeds","Equipment"];
      const seasons = ["Kharif","Rabi"];
      const baseLat = 15.0, baseLon = 75.0;

      const data = [];
      for (let i=0;i<rows;i++){
        const d = dealers[Math.floor(Math.random()*dealers.length)];
        const b = beneficiaries[Math.floor(Math.random()*beneficiaries.length)];
        const scheme = schemes[Math.floor(Math.random()*schemes.length)];
        const season = seasons[Math.floor(Math.random()*seasons.length)];
        const district = d.district;
        const cap = schemeCapsPerAcre[scheme];
        const qty = +(b.landHolding * cap * (Math.random()*1.2+0.6)).toFixed(2);
        let qtyAdj = qty;
        if (Math.random() < 0.08) qtyAdj = +(qty * (Math.random()*2+1.8)).toFixed(2);
        const lat = +(baseLat + (Math.random()-0.5)*4).toFixed(4);
        const lon = +(baseLon + (Math.random()-0.5)*4).toFixed(4);
        const date = randomDateInSeason(season);
        data.push({
          transactionId: "T"+String(i+1).padStart(5,"0"),
          dealerId: d.dealerId,
          dealerName: d.dealerName,
          beneficiaryId: b.beneficiaryId,
          beneficiaryName: b.beneficiaryName,
          scheme, season, district,
          quantity: qtyAdj,
          landHolding: b.landHolding,
          lat, lon, date
        });
      }

      const highDealer = dealers[0].dealerId;
      for (let k=0;k<100;k++){
        const b = beneficiaries[Math.floor(Math.random()*beneficiaries.length)];
        data.push({
          transactionId: "T"+String(rows+k+1).padStart(5,"0"),
          dealerId: highDealer,
          dealerName: "Dealer 1",
          beneficiaryId: b.beneficiaryId,
          beneficiaryName: b.beneficiaryName,
          scheme: "Fertilizer",
          season: "Kharif",
          district: dealers[0].district,
          quantity: +(b.landHolding * schemeCapsPerAcre["Fertilizer"] * (Math.random()*1.1+0.9)).toFixed(2),
          landHolding: b.landHolding,
          lat: +(baseLat + (Math.random()-0.5)*1.5).toFixed(4),
          lon: +(baseLon + (Math.random()-0.5)*1.5).toFixed(4),
          date: randomDateInSeason("Kharif")
        });
      }

      const clusterCenter = {lat: baseLat+0.8, lon: baseLon+0.7};
      const clusterDate = new Date("2025-07-15");
      for (let m=0;m<60;m++){
        const b = beneficiaries[Math.floor(Math.random()*beneficiaries.length)];
        data.push({
          transactionId: "T"+String(rows+100+m+1).padStart(5,"0"),
          dealerId: "D010",
          dealerName: "Dealer 10",
          beneficiaryId: b.beneficiaryId,
          beneficiaryName: b.beneficiaryName,
          scheme: "Seeds",
          season: "Kharif",
          district: "Mandya",
          quantity: +(b.landHolding * schemeCapsPerAcre["Seeds"] * (Math.random()*0.6+1.4)).toFixed(2),
          landHolding: b.landHolding,
          lat: +(clusterCenter.lat + (Math.random()-0.5)*0.12).toFixed(4),
          lon: +(clusterCenter.lon + (Math.random()-0.5)*0.12).toFixed(4),
          date: clusterDate.toISOString().slice(0,10)
        });
      }
      return data;
    }

    function randomDateInSeason(season){
      const ranges = {
        Kharif: ["2025-06-01","2025-10-31"],
        Rabi: ["2025-11-01","2026-03-15"]
      };
      const [start,end] = ranges[season];
      const s = new Date(start).getTime();
      const e = new Date(end).getTime();
      const t = s + Math.random()*(e-s);
      return new Date(t).toISOString().slice(0,10);
    }

    // ---------------------------
    // CSV parsing (transactions)
    // ---------------------------
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(",").map(h=>h.trim());
      const rows = [];
      for (let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h,idx)=>{ obj[h] = cols[idx] ?? ""; });
        obj.quantity = +obj.quantity;
        obj.landHolding = +obj.landHolding;
        obj.lat = +obj.lat;
        obj.lon = +obj.lon;
        rows.push(obj);
      }
      return rows;
    }
    function splitCSVLine(line){
      const result = []; let current = ""; let inQuotes = false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"'){
          if (inQuotes && line[i+1] === '"'){ current += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes){
          result.push(current); current = "";
        } else { current += c; }
      }
      result.push(current);
      return result.map(s=>s.trim());
    }

    // ---------------------------
    // Detection
    // ---------------------------
    function computeDealerStats(data){
      dealerStats = new Map();
      const byDealer = new Map();
      data.forEach(tx=>{
        const k = tx.dealerId;
        if (!byDealer.has(k)) byDealer.set(k, []);
        byDealer.get(k).push(tx);
      });

      const districtDealerVolumes = new Map();
      data.forEach(tx=>{
        const k = `${tx.district}:${tx.dealerId}`;
        districtDealerVolumes.set(k, (districtDealerVolumes.get(k)||0)+1);
      });

      const districtStats = new Map();
      const districtToDealerVolumes = new Map();
      districtDealerVolumes.forEach((vol, key)=>{
        const [dist] = key.split(":");
        if (!districtToDealerVolumes.has(dist)) districtToDealerVolumes.set(dist, []);
        districtToDealerVolumes.get(dist).push(vol);
      });
      districtToDealerVolumes.forEach((list, dist)=>{
        const mean = list.reduce((a,b)=>a+b,0)/list.length;
        const sd = Math.sqrt(list.reduce((acc,v)=> acc + Math.pow(v-mean,2),0)/list.length);
        districtStats.set(dist, {mean, sd});
      });

      byDealer.forEach((list, dealerId)=>{
        const dist = list[0].district;
        const vol = list.length;
        const {mean, sd} = districtStats.get(dist) || {mean: 0, sd: 0.0001};
        const z = sd ? (vol - mean)/sd : 0;
        dealerStats.set(dealerId, {dealerId, dealerName: list[0].dealerName, district: dist, volume: vol, zscore: z});
      });
    }

    function detectAnomalies(data){
      anomalies = [];
      computeDealerStats(data);

      // Quantity vs land caps
      data.forEach(tx=>{
        const caps = schemeCapsPerAcre[tx.scheme] || 0;
        const capQty = tx.landHolding * caps;
        const exceedRatio = (capQty > 0) ? tx.quantity / capQty : 0;
        if (exceedRatio > quantityRatioThreshold){
          const score = scoreFromRatio(exceedRatio);
          anomalies.push(makeAnomaly(tx, "QuantityVsLand", score, severityFromScore(score)));
        }
      });

      // Dealer volume outlier
      dealerStats.forEach(stat=>{
        if (stat.zscore > dealerZThreshold){
          const dealerTx = data.filter(t=>t.dealerId === stat.dealerId);
          const sample = dealerTx.slice(0, Math.min(30, dealerTx.length));
          sample.forEach(tx=>{
            const score = Math.min(100, 60 + (stat.zscore-dealerZThreshold)*15);
            anomalies.push(makeAnomaly(tx, "DealerVolumeOutlier", score, severityFromScore(score), {zscore: +stat.zscore.toFixed(2), volume: stat.volume}));
          });
        }
      });

      // Geo-temporal clusters
      const radiusKm = 10;
      const windowDays = 7;
      const points = data.map(tx=>({lat: tx.lat, lon: tx.lon, date: new Date(tx.date), tx}));
      const clusters = findClusters(points, radiusKm, windowDays, 12);
      clusters.forEach(cluster=>{
        cluster.points.forEach(p=>{
          const score = Math.min(100, 50 + (cluster.points.length-12)*3);
          anomalies.push(makeAnomaly(p.tx, "GeoTemporalCluster", score, severityFromScore(score), {clusterSize: cluster.points.length}));
        });
      });

      anomalies.sort((a,b)=>{
        const sOrder = {"High":3,"Medium":2,"Low":1};
        if (sOrder[b.severity] !== sOrder[a.severity]) return sOrder[b.severity] - sOrder[a.severity];
        return b.score - a.score;
      });
      filteredAnomalies = anomalies.slice();
    }

    function makeAnomaly(tx, type, score, severity, extra={}){
      return {
        severity, score: Math.round(score),
        type,
        dealer: `${tx.dealerName} (${tx.dealerId})`,
        beneficiary: `${tx.beneficiaryName} (${tx.beneficiaryId})`,
        scheme: tx.scheme,
        season: tx.season,
        district: tx.district,
        quantity: tx.quantity,
        landHolding: tx.landHolding,
        lat: tx.lat, lon: tx.lon,
        date: tx.date,
        meta: extra
      };
    }

    function scoreFromRatio(r){ return Math.min(100, 40 + (r-quantityRatioThreshold)*40); }
    function severityFromScore(score){
      if (score >= 75) return "High";
      if (score >= 55) return "Medium";
      return "Low";
    }

    // Haversine + clustering helpers
    function distanceKm(a,b){
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI/180;
      const dLon = (b.lon - a.lon) * Math.PI/180;
      const lat1 = a.lat * Math.PI/180;
      const lat2 = b.lat * Math.PI/180;
      const x = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
      return 2 * R * Math.asin(Math.sqrt(x));
    }
    function daysBetween(a,b){ return Math.abs((b - a) / (1000*60*60*24)); }
    function findClusters(points, radiusKm, windowDays, minPts){
      const visited = new Set();
      const clusters = [];
      for (let i=0;i<points.length;i++){
        if (visited.has(i)) continue;
        const neighbors = [];
        for (let j=0;j<points.length;j++){
          if (i===j) continue;
          if (distanceKm(points[i], points[j]) <= radiusKm && daysBetween(points[i].date, points[j].date) <= windowDays){
            neighbors.push(j);
          }
        }
        if (neighbors.length + 1 >= minPts){
          const clusterIdx = new Set([i, ...neighbors]);
          clusterIdx.forEach(idx=> visited.add(idx));
          clusters.push({points: Array.from(clusterIdx).map(idx=>points[idx])});
        }
      }
      return clusters;
    }

    // ---------------------------
    // Rendering
    // ---------------------------
    function renderAll(){
      document.getElementById("kpiTransactions").innerText = transactions.length.toLocaleString();
      document.getElementById("kpiBeneficiaries").innerText = new Set(transactions.map(t=>t.beneficiaryId)).size.toLocaleString();
      document.getElementById("kpiDealers").innerText = new Set(transactions.map(t=>t.dealerId)).size.toLocaleString();
      document.getElementById("kpiAnomalies").innerText = anomalies.length.toLocaleString();

      renderCharts();
      renderMap();
      renderAnomalyTable();
    }

    function renderCharts(){
      const ctx1 = document.getElementById("chartDealerVolume");
      const ctx2 = document.getElementById("chartAnomalyTypes");

      const volumes = Array.from(dealerStats.values())
        .sort((a,b)=>b.volume-a.volume)
        .slice(0, 12);
      const labels1 = volumes.map(v=>v.dealerName);
      const data1 = volumes.map(v=>v.volume);

      if (charts.dealer) charts.dealer.destroy();
      charts.dealer = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: labels1,
          datasets: [{
            label: 'Transactions by dealer',
            data: data1,
            backgroundColor: data1.map(v=> v > (average(data1)*1.4) ? 'rgba(220,38,38,0.6)' : 'rgba(43,122,120,0.6)')
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterBody: (items)=>{
                  const idx = items[0].dataIndex;
                  const stat = volumes[idx];
                  return `District: ${stat.district}\nZ-score: ${stat.zscore.toFixed(2)}`;
                }
              }
            }
          },
          scales: { y: { beginAtZero: true } },
          onClick: (evt, elements)=>{
            const el = charts.dealer.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
            if (el.length){
              const idx = el[0].index;
              const stat = volumes[idx];
              document.getElementById("dealerSearch").value = stat.dealerId;
              renderDealerInfo(stat.dealerId.toLowerCase());
              filteredAnomalies = anomalies.filter(a=> a.dealer.includes(stat.dealerId));
              renderAnomalyTable();
              document.getElementById("chipActiveFilters").innerText = `Dealer: ${stat.dealerName}`;
              aiNarrate(`Focused on ${stat.dealerName} (${stat.dealerId}). Volume ${stat.volume}, z-score ${stat.zscore.toFixed(2)}. Showing related anomalies.`);
            }
          }
        }
      });

      const typeCounts = {};
      anomalies.forEach(a=> typeCounts[a.type] = (typeCounts[a.type]||0)+1);
      const labels2 = Object.keys(typeCounts);
      const data2 = Object.values(typeCounts);
      if (charts.types) charts.types.destroy();
      charts.types = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: labels2,
          datasets: [{ data: data2, backgroundColor: ['#ef4444','#f59e0b','#3b82f6','#10b981','#8b5cf6'] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${ctx.formattedValue}` } }
          }
        }
      });
    }

    function renderMap(){
      if (!map){
        map = L.map('map').setView([15.5, 75.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      }
      if (markersLayer) markersLayer.clearLayers();
      markersLayer = L.layerGroup().addTo(map);

      const showHeat = document.getElementById("toggleHeat").checked;

      const byDistrict = groupBy(transactions, t=>t.district);
      Object.entries(byDistrict).forEach(([dist, list])=>{
        const coords = centroid(list.map(l=>({lat:l.lat, lon:l.lon})));
        if (!isFinite(coords.lat) || !isFinite(coords.lon)) return;
        const anomalyCount = anomalies.filter(a=>a.district===dist).length;
        const share = list.length ? anomalyCount / list.length : 0;
        const color = share > 0.3 ? '#dc2626' : (share > 0.15 ? '#f59e0b' : '#2b7a78');
        const radius = Math.min(30000, 8000 + list.length*40);
        const circleOpts = showHeat
          ? { color, fillColor: color, fillOpacity: 0.3, radius }
          : { color: color, fillColor: color, fillOpacity: 0.15, radius: 7000 };
        const circle = L.circle([coords.lat, coords.lon], circleOpts)
          .bindPopup(`<b>${dist}</b><br>Tx: ${list.length}<br>Anomalies: ${anomalyCount}<br>Share: ${(share*100).toFixed(1)}%`);
        circle.addTo(markersLayer);
      });

      const clusterAnoms = anomalies.filter(a=>a.type==="GeoTemporalCluster");
      clusterAnoms.slice(0, 300).forEach(a=>{
        if (!isFinite(a.lat) || !isFinite(a.lon)) return;
        const m = L.circleMarker([a.lat, a.lon], {
          radius: 5, color: '#b91c1c', fillColor: '#b91c1c', fillOpacity: 0.8
        }).bindPopup(`<b>${a.type}</b><br>${a.dealer}<br>${a.beneficiary}<br>${a.date}<br>Score: ${a.score}`);
        m.addTo(markersLayer);
      });
    }

    function renderAnomalyTable(){
      let rows = filteredAnomalies.slice();
      const ds = document.getElementById("dateStart").value;
      const de = document.getElementById("dateEnd").value;
      if (ds) rows = rows.filter(r=> r.date >= ds);
      if (de) rows = rows.filter(r=> r.date <= de);

      const q = document.getElementById("tableSearch").value.trim().toLowerCase();
      if (q){
        rows = rows.filter(r=> Object.values({
          severity:r.severity, score:r.score, type:r.type, dealer:r.dealer, beneficiary:r.beneficiary,
          scheme:r.scheme, season:r.season, district:r.district, quantity:r.quantity, landHolding:r.landHolding, date:r.date
        }).join(" ").toLowerCase().includes(q));
      }

      const tbody = document.querySelector("#anomalyTable tbody");
      tbody.innerHTML = "";
      rows.forEach(a=>{
        const tr = document.createElement("tr");
        const badgeClass = a.severity === "High" ? "badge badge-danger" :
                           a.severity === "Medium" ? "badge badge-warning" : "badge badge-success";
        tr.innerHTML = `
          <td><span class="${badgeClass}">${a.severity}</span></td>
          <td>${a.score}</td>
          <td>${a.type}</td>
          <td>${a.dealer}</td>
          <td>${a.beneficiary}</td>
          <td>${a.scheme}</td>
          <td>${a.season}</td>
          <td>${a.district}</td>
          <td>${a.quantity}</td>
          <td>${a.landHolding}</td>
          <td>${a.date}</td>
        `;
        tr.addEventListener("click", ()=>{
          if (map && isFinite(a.lat) && isFinite(a.lon)){
            L.popup().setLatLng([a.lat,a.lon])
              .setContent(`<b>${a.type}</b><br>${a.dealer}<br>${a.beneficiary}<br>${a.date}`)
              .openOn(map);
          }
          const bid = a.beneficiary.match(/\((.*?)\)/)?.[1] || "";
          document.getElementById("beneficiarySearch").value = bid;
          renderBeneficiaryInfo(bid.toLowerCase());
          aiNarrate(`Opened ${a.type} at ${a.district} for ${a.dealer} → ${a.beneficiary}. Severity ${a.severity}, score ${a.score}.`);
        });
        tbody.appendChild(tr);
      });
      document.getElementById("tableCount").innerText = `${rows.length} anomalies shown`;
    }

    // ---------------------------
    // Utilities
    // ---------------------------
    function average(arr){ return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
    function groupBy(arr, fn){
      const map = {};
      arr.forEach(item=>{
        const k = fn(item);
        if (!map[k]) map[k] = [];
        map[k].push(item);
      });
      return map;
    }
    function centroid(points){
      if (!points.length) return {lat: NaN, lon: NaN};
      const lat = average(points.map(p=>p.lat));
      const lon = average(points.map(p=>p.lon));
      return {lat, lon};
    }

    // ---------------------------
    // Filtering and export
    // ---------------------------
    function applyFilters(){
      const scheme = document.getElementById("filterScheme").value;
      const season = document.getElementById("filterSeason").value;
      const district = document.getElementById("filterDistrict").value.trim().toLowerCase();
      const severity = document.getElementById("filterSeverity").value;

      filteredAnomalies = anomalies.filter(a=>{
        if (scheme && a.scheme !== scheme) return false;
        if (season && a.season !== season) return false;
        if (severity && a.severity !== severity) return false;
        if (district && a.district.toLowerCase().indexOf(district) === -1) return false;
        return true;
      });
      renderAnomalyTable();

      const labels = [];
      if (scheme) labels.push(`Scheme: ${scheme}`);
      if (season) labels.push(`Season: ${season}`);
      if (severity) labels.push(`Severity: ${severity}`);
      if (district) labels.push(`District: ${district}`);
      document.getElementById("chipActiveFilters").innerText = labels.length ? labels.join(" | ") : "No filters";
      aiNarrate(`Applied filters → ${labels.join(", ") || "none"}.`);
    }

    function resetFilters(){
      document.getElementById("filterScheme").value = "";
      document.getElementById("filterSeason").value = "";
      document.getElementById("filterDistrict").value = "";
      document.getElementById("filterSeverity").value = "";
      document.getElementById("dateStart").value = "";
      document.getElementById("dateEnd").value = "";
      document.getElementById("tableSearch").value = "";
      filteredAnomalies = anomalies.slice();
      renderAnomalyTable();
      document.getElementById("chipActiveFilters").innerText = "No filters";
      aiNarrate("Filters reset. Showing all anomalies.");
    }

    function downloadCSV(filename, rows){
      const header = ["severity","score","type","dealer","beneficiary","scheme","season","district","quantity","landHolding","lat","lon","date"];
      const csv = [header.join(",")]
        .concat(rows.map(r=> header.map(h=> `"${String(r[h] ?? "").replace(/"/g,'""')}"`).join(",")))
        .join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // ---------------------------
    // Drilldowns
    // ---------------------------
    function renderDealerInfo(query){
      const container = document.getElementById("dealerInfo");
      if (!query){ container.innerHTML = "<p class='note'>Enter a dealer name or ID.</p>"; return; }
      const matches = transactions.filter(t=> (t.dealerId.toLowerCase().includes(query) || t.dealerName.toLowerCase().includes(query)));
      if (!matches.length){ container.innerHTML = "<p class='note'>No matching dealer found.</p>"; return; }
      const dId = matches[0].dealerId;
      const stat = dealerStats.get(dId);
      const count = matches.length;
      const anoms = anomalies.filter(a=> a.dealer.indexOf(dId) !== -1);
      const schemes = Object.entries(groupBy(matches, m=>m.scheme)).map(([k,v])=> `${k} (${v.length})`).join(", ");
      container.innerHTML = `
        <div><b>${stat?.dealerName || matches[0].dealerName}</b> (${dId})</div>
        <div>District: ${stat?.district || matches[0].district}</div>
        <div>Transactions: ${count} | Anomalies: ${anoms.length} | Z-score: ${stat ? stat.zscore.toFixed(2) : "-"}</div>
        <div>Schemes: ${schemes}</div>
      `;
    }
    function renderBeneficiaryInfo(query){
      const container = document.getElementById("beneficiaryInfo");
      if (!query){ container.innerHTML = "<p class='note'>Enter a beneficiary name or ID.</p>"; return; }
      const matches = transactions.filter(t=> (t.beneficiaryId.toLowerCase().includes(query) || t.beneficiaryName.toLowerCase().includes(query)));
      if (!matches.length){ container.innerHTML = "<p class='note'>No matching beneficiary found.</p>"; return; }
      const bId = matches[0].beneficiaryId;
      const count = matches.length;
      const land = matches[0].landHolding;
      const anoms = anomalies.filter(a=> a.beneficiary.indexOf(bId) !== -1);
      const dealers = Object.entries(groupBy(matches, m=>m.dealerName)).map(([k,v])=> `${k} (${v.length})`).join(", ");
      container.innerHTML = `
        <div><b>${matches[0].beneficiaryName}</b> (${bId})</div>
        <div>Land holding: ${land} acres</div>
        <div>Transactions: ${count} | Anomalies: ${anoms.length}</div>
        <div>Dealers: ${dealers}</div>
      `;
    }

    // ---------------------------
    // Table sorting
    // ---------------------------
    let sortKey = null; let sortAsc = true;
    document.querySelectorAll("#anomalyTable thead th").forEach(th=>{
      th.addEventListener("click", ()=>{
        sortKey = th.getAttribute("data-sort");
        sortAsc = !sortAsc;
        filteredAnomalies.sort((a,b)=>{
          const va = a[sortKey]; const vb = b[sortKey];
          if (sortKey === "score" || sortKey === "quantity" || sortKey === "landHolding"){
            return sortAsc ? (va - vb) : (vb - va);
          }
          return sortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
        renderAnomalyTable();
      });
    });

    // ---------------------------
    // AI Assistant (on-device rules & analytics)
    // ---------------------------
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const chatSendEl = document.getElementById("chatSend");
    const typingEl = document.getElementById("typingIndicator");

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.innerHTML = `<div class="bubble">${text}</div>`;
      chatMessagesEl.appendChild(div);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
    function aiTyping(on){
      typingEl.classList.toggle("hidden", !on);
    }
    function aiNarrate(text){
      addMsg("ai", text);
    }

    function summarizeAnomalies(){
      const total = anomalies.length;
      const bySeverity = groupCount(anomalies, a=>a.severity);
      const byType = groupCount(anomalies, a=>a.type);
      const topDistrict = topN(groupCount(anomalies, a=>a.district), 1)[0];
      const topDealer = topN(groupCount(anomalies, a=>a.dealer.split(" (")[0]), 1)[0];
      return `We have ${total} anomalies. Severity split → High: ${bySeverity.High||0}, Medium: ${bySeverity.Medium||0}, Low: ${bySeverity.Low||0}. Most frequent type: ${topKey(byType)}. Riskiest district by count: ${topDistrict?.key||"-"} (${topDistrict?.count||0}). Dealer with most flags: ${topDealer?.key||"-"} (${topDealer?.count||0}).`;
    }
    function groupCount(arr, fn){
      const map = {};
      arr.forEach(x=>{ const k = fn(x); map[k] = (map[k]||0)+1; });
      return map;
    }
    function topN(countMap, n){
      return Object.entries(countMap).map(([key,count])=>({key,count})).sort((a,b)=>b.count-a.count).slice(0,n);
    }
    function topKey(countMap){
      const t = topN(countMap,1)[0];
      return t ? `${t.key} (${t.count})` : "-";
    }

    function applyNLFilters(text){
      const t = text.toLowerCase();
      const scheme = ["fertilizer","seeds","equipment"].find(s=> t.includes(s));
      const season = ["kharif","rabi"].find(s=> t.includes(s));
      const sev = ["high","medium","low"].find(s=> t.includes(s));
      const districtMatch = t.match(/(belagavi|bidar|ballari|haveri|kalaburagi|mysuru|mandya|tumakuru|dharwad|koppal)/);
      document.getElementById("filterScheme").value = scheme ? capitalize(scheme) : "";
      document.getElementById("filterSeason").value = season ? capitalize(season) : "";
      document.getElementById("filterSeverity").value = sev ? capitalize(sev) : "";
      document.getElementById("filterDistrict").value = districtMatch ? capitalize(districtMatch[0]) : "";
      applyFilters();
      return `Applied filters → ${scheme?capitalize(scheme):"All"} | ${season?capitalize(season):"All"} | ${districtMatch?capitalize(districtMatch[0]):"Any district"} | ${sev?capitalize(sev):"All severities"}.`;
    }
    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    function showTopDealers(n=5){
      const counts = groupCount(anomalies, a=>a.dealer.split(" (")[0]);
      const top = topN(counts, n);
      return top.map((x,i)=> `${i+1}. ${x.key} — ${x.count}`).join("\n");
    }

    function riskiestDistrict(){
      const counts = groupCount(anomalies, a=>a.district);
      const top = topN(counts,1)[0];
      return top ? top.key : null;
    }

    function auditChecklistForDistrict(dist){
      const distAnoms = anomalies.filter(a=> a.district === dist);
      const types = groupCount(distAnoms, a=>a.type);
      const dealers = topN(groupCount(distAnoms, a=>a.dealer.split(" (")[0]), 5);
      const when = topN(groupCount(distAnoms, a=>a.date.slice(0,7)), 3);
      return [
        `District focus: ${dist}`,
        `Dominant anomaly type: ${topKey(types)}`,
        `Top dealers to audit: ${dealers.map(d=>d.key).join(", ") || "-"}`,
        `Hot months: ${when.map(w=>w.key).join(", ") || "-"}`,
        `Actions:`,
        `- Verify dealer stock and invoices vs claimed subsidies`,
        `- Cross-check quantity caps per acre in farm records`,
        `- Field visits for clustered claims within tight date windows`,
        `- Validate beneficiary identities and land records`
      ].join("\n");
    }

    function handleChat(query){
      addMsg("user", query);
      aiTyping(true);
      setTimeout(()=>{
        aiTyping(false);
        const q = query.trim().toLowerCase();

        // Intent detection (simple rules)
        if (q.includes("summarize")) {
          aiNarrate(summarizeAnomalies());
          return;
        }
        if (q.match(/top\s+\d+\s+dealers/) || q.includes("top dealers")){
          const nMatch = q.match(/top\s+(\d+)/);
          const n = nMatch ? parseInt(nMatch[1],10) : 5;
          aiNarrate(`Top dealers by anomaly count:\n${showTopDealers(n)}`);
          return;
        }
        if (q.includes("apply") || q.includes("filter")){
          aiNarrate(applyNLFilters(q));
          return;
        }
        if (q.includes("cluster") || q.includes("geospatial")){
          document.getElementById("toggleHeat").checked = true;
          renderMap();
          aiNarrate("Enabled district density circles and highlighted cluster anomalies on the map.");
          return;
        }
        if (q.includes("audit") || q.includes("checklist")){
          const dist = riskiestDistrict() || "—";
          if (dist === "—"){
            aiNarrate("I couldn't find a district with anomalies yet. Load data or adjust thresholds.");
          } else {
            aiNarrate(auditChecklistForDistrict(dist));
          }
          return;
        }
        if (q.includes("riskiest district") || q.includes("which district looks riskiest")){
          const dist = riskiestDistrict();
          aiNarrate(dist ? `Riskiest district by anomaly count: ${dist}.` : "No anomalies yet.");
          return;
        }
        // Dealer or beneficiary focus
        const dealerIdMatch = q.match(/d0?\d{2,3}/i);
        if (dealerIdMatch){
          const dId = dealerIdMatch[0].toUpperCase();
          document.getElementById("dealerSearch").value = dId;
          renderDealerInfo(dId.toLowerCase());
          filteredAnomalies = anomalies.filter(a=> a.dealer.includes(dId));
          renderAnomalyTable();
          aiNarrate(`Focused on dealer ${dId}. Showing related anomalies and drilldown.`);
          return;
        }
        const benIdMatch = q.match(/b0?\d{3,4}/i);
        if (benIdMatch){
          const bId = benIdMatch[0].toUpperCase();
          document.getElementById("beneficiarySearch").value = bId;
          renderBeneficiaryInfo(bId.toLowerCase());
          aiNarrate(`Opened beneficiary ${bId} drilldown.`);
          return;
        }

        // Fallback: smart summary with hint to filters
        aiNarrate("I can summarize anomalies, apply filters (e.g., “Seeds, Kharif, High, Mandya”), show top dealers, highlight clusters, or generate an audit checklist. Try: “Apply filters for Seeds in Kharif with High severity.”");
      }, 400);
    }

    // Quick actions
    document.querySelectorAll(".qa-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> handleChat(btn.getAttribute("data-q")));
    });
    chatSendEl.addEventListener("click", ()=> {
      const q = chatInputEl.value.trim();
      if (!q) return;
      chatInputEl.value = "";
      handleChat(q);
    });
    chatInputEl.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){ chatSendEl.click(); }
    });

    // ---------------------------
    // Events
    // ---------------------------
    document.getElementById("applyFilters").addEventListener("click", applyFilters);
    document.getElementById("resetFilters").addEventListener("click", resetFilters);
    document.getElementById("downloadReport").addEventListener("click", ()=>{
      const ds = document.getElementById("dateStart").value;
      const de = document.getElementById("dateEnd").value;
      let exportRows = filteredAnomalies.slice();
      if (ds) exportRows = exportRows.filter(r=> r.date >= ds);
      if (de) exportRows = exportRows.filter(r=> r.date <= de);
      const q = document.getElementById("tableSearch").value.trim().toLowerCase();
      if (q){
        exportRows = exportRows.filter(r=> Object.values(r).join(" ").toLowerCase().includes(q));
      }
      if (!exportRows.length) return alert("No anomalies to export.");
      downloadCSV("anomalies.csv", exportRows);
      aiNarrate(`Exported ${exportRows.length} anomalies to CSV.`);
    });

    document.getElementById("dealerSearch").addEventListener("input", (e)=> renderDealerInfo(e.target.value.trim().toLowerCase()));
    document.getElementById("beneficiarySearch").addEventListener("input", (e)=> renderBeneficiaryInfo(e.target.value.trim().toLowerCase()));
    document.getElementById("tableSearch").addEventListener("input", renderAnomalyTable);
    document.getElementById("toggleHeat").addEventListener("change", renderMap);

    document.getElementById("zSlider").addEventListener("input", (e)=>{
      dealerZThreshold = parseFloat(e.target.value);
      document.getElementById("zLabel").innerText = dealerZThreshold.toFixed(1);
      detectAnomalies(transactions); renderAll();
      aiNarrate(`Dealer z-score threshold set to ${dealerZThreshold.toFixed(1)}.`);
    });
    document.getElementById("ratioSlider").addEventListener("input", (e)=>{
      quantityRatioThreshold = parseFloat(e.target.value);
      document.getElementById("ratioLabel").innerText = quantityRatioThreshold.toFixed(2);
      detectAnomalies(transactions); renderAll();
      aiNarrate(`Quantity vs land ratio threshold set to ${quantityRatioThreshold.toFixed(2)}x.`);
    });

    document.getElementById("fileInput").addEventListener("change", async (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById("loadSpinner").classList.add("show");
      const text = await file.text();
      transactions = parseCSV(text);
      detectAnomalies(transactions);
      renderAll();
      resetFilters();
      document.getElementById("loadSpinner").classList.remove("show");
      aiNarrate(`Loaded ${transactions.length} transactions from CSV and detected ${anomalies.length} anomalies.`);
    });

    document.getElementById("loadSample").addEventListener("click", ()=>{
      transactions = makeSampleData(800);
      detectAnomalies(transactions);
      renderAll();
      resetFilters();
      aiNarrate("Sample dataset loaded. Charts, map, and anomalies updated.");
    });

    // Init
    window.addEventListener("load", ()=>{
      transactions = makeSampleData(800);
      detectAnomalies(transactions);
      renderAll();
      renderDealerInfo("");
      renderBeneficiaryInfo("");
      aiNarrate("Welcome. Ask me to summarize anomalies, apply filters, or generate an audit plan.");
    });
  </script>
</body>
</html>
